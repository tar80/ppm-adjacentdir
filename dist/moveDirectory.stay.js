Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){var n;if(null==this)throw new Error('Array.indexOf: "this" is null or not defined');var r=Object(this),a=r.length>>>0;if(0===a)return-1;var i=null!=t?t:0;if(Math.abs(i)===Infinity&&(i=0),i>=a)return-1;for(n=Math.max(i>=0?i:a-Math.abs(i),0);n<a;){if(n in r&&r[n]===e)return n;n++}return-1});var validArgs=function(){for(var e=[],t=PPx.Arguments;!t.atEnd();t.moveNext())e.push(t.value);return e},e={ppmName:"ppx-plugin-manager",ppmVersion:.95,language:"ja",encode:"utf16le",nlcode:"\r\n",nltype:"crlf",ppmID:"P",ppmSubID:"Q"},useLanguage=function(){var t=PPx.Extract("%*getcust(S_ppm#global:lang)");return"en"===t||"ja"===t?t:e.language},tmp=function(){var e=PPx.Extract('%*extract(C,"%%*temp()")');return{dir:e,file:e+"_ppmtemp",lf:e+"_temp.xlf",stdout:e+"_stdout",stderr:e+"_stderr",ppmDir:function(){var e=PPx.Extract("%'temp'%\\ppm");return PPx.Execute("*makedir "+e),e}}},isEmptyStr=function(e){return""===e},isError=function(e,t){return e&&"string"==typeof t},t=PPx.CreateObject("Scripting.FileSystemObject"),expandNlCode=function(e){var t="\n",n=e.indexOf("\r");return~n&&(t="\r\n"===e.substring(n,n+2)?"\r\n":"\r"),t},_exec=function(e,t){try{var n;return[!1,null!=(n=t())?n:""]}catch(r){return[!0,""]}finally{e.Close()}},read=function(e){var n=e.path,r=e.enc,a=void 0===r?"utf8":r;if(!t.FileExists(n))return[!0,n+" not found"];var i=t.GetFile(n);if(0===i.Size)return[!0,n+" has no data"];var u=!1,o="";if("utf8"===a){var c=PPx.CreateObject("ADODB.Stream"),s=_exec(c,(function(){return c.Open(),c.Charset="UTF-8",c.LoadFromFile(n),c.ReadText(-1)}));u=s[0],o=s[1]}else{var p="utf16le"===a?-1:0,f=i.OpenAsTextStream(1,p),l=_exec(f,(function(){return f.ReadAll()}));u=l[0],o=l[1]}return u?[!0,"Unable to read "+n]:[!1,o]},readLines=function(e){var t,n=e.path,r=e.enc,a=void 0===r?"utf8":r,i=e.linefeed,u=read({path:n,enc:a}),o=u[0],c=u[1];if(o)return[!0,c];i=null!=(t=i)?t:expandNlCode(c.slice(0,1e3));var s=c.split(i);return isEmptyStr(s[s.length-1])&&s.pop(),[!1,{lines:s,nl:i}]},pathSelf=function(){var e,t,n=PPx.ScriptName;return~n.indexOf("\\")?(e=extractFileName(n),t=PPx.Extract("%*name(DKN,"+n+")")):(e=n,t=PPx.Extract("%FDN")),{scriptName:e,parentDir:t.replace(/\\$/,"")}},extractFileName=function(e,t){return void 0===t&&(t="\\"),"\\"!==t&&"/"!==t&&(t="\\"),e.slice(e.lastIndexOf(t)+1)},ppx_Discard=function(e,t){var n;PPx.StayMode=0,t=null!=(n=t)?n:"","DEBUG"===e&&PPx.linemessage("[DEBUG] discard "+t)},n=["KC_main","KV_main","KV_img","KV_crt","KV_page","KB_edit","K_ppe","K_edit"],_validTable=function(e){return~n.indexOf(e)?e:"KC_main"},_discard=function(e){return function(t){var n=t.table,r=t.label,a=t.mapkey,i=t.cond,u=void 0===i?"instantly":i,o=t.debug,c=void 0===o?"0":o,s=PPx.StayMode,p=PPx.Extract("%n"),f=PPx.Extract("%FDV"),l="*linecust "+r+p+","+_validTable(n)+":"+e+",",d={instantly:"",once:'*if("'+p+'"=="%n")%:',hold:'*if("'+p+'"=="%n")&&("'+f+'"!="%FDV")%:'}[u],x=[l];a&&(PPx.Execute("*mapkey use,"+a),x.push("*mapkey delete,"+a)),x.push('*js ":'+s+',ppx_Discard",'+c+","+r),PPx.Execute(l+"%(*if %*stayinfo("+s+")%:"+d+x.join("%:")+"%)"),PPx.Execute('*run -nostartmsg %0pptrayw.exe -c %%K"@LOADCUST"')}},getStaymodeId=function(e){e=e.indexOf(".")?e.slice(0,e.indexOf(".")):e;var t=Number(PPx.Extract("%*getcust(S_ppm#staymode:"+e+")"));return!Number.isNaN(t)&&t>1e4&&t},r={hold:function(e,t){var n="discardStayMode.js";PPx.Execute("*run -noppb -hide -nostartmsg %0ppbw.exe -c *script %sgu'ppmlib'\\"+n+",%n,"+e+","+t)}},a=(_discard("ACTIVEEVENT"),_discard("LOADEVENT"),function(e,t,n,r,a){var i="*linecust "+n+","+_validTable(e),u=i+":"+t+",",o={instantly:"",once:'*if("%n"=="%%n")',hold:'*if("%n"=="%%n")&&("%FDV"=="%%FDV")'}[a];PPx.Execute(i+":"+t+","+o+"%%:"+u+"%%:"+r),PPx.Execute('%K"@LOADCUST"')}),i={sortDetail:function(e,t,n){return 0!==e&&(e=1),{0:{l:-1,r:1,msg:t},1:{l:1,r:-1,msg:n}}[e]},pathDetail:function(e){var t={path:"",wd:"",name:"",ext:"",type:0},n=/^(.*)\\((?:.*\.)?(?!$)(.*))/;return PPx.Extract(e).replace(n,(function(e,n,r,a){return t.path=e+"\\",t.wd=n,t.name=r,t.ext="."+a.toLowerCase(),t.type=PPx.DirectoryType,""})),t.wd?t:undefined}},u=80140,o={ROOT:"<<root>>",TOP:"<top>",BOTTOM:"<bottom>"},c={en:{noItem:"No adjacent directories",notSupport:"Not supported"},ja:{noItem:"隣接ディレクトリはありません",notSupport:"非対象"}}[useLanguage()],s=pathSelf().scriptName,cache={wd:"",ext:"",debounce:"0",isStaymode:!1,isDebug:!1,data:{}},main=function(){var e=validArgs(),t=e[0],n=e[1],a=e[2];if(cache.isStaymode=hasDebounceTime(n),cache.isDebug="DEBUG"===a,cache.isStaymode){var i=getStaymodeId(s)||u;PPx.StayMode=i,cache.debounce=n,debugMsg("linemessage","start "+i),r.hold(i,a)}ppx_resume(t,n)},ppx_resume=function(e,t){void 0===e&&(e="1");var n=i.sortDetail(Number(e),o.TOP,o.BOTTOM),r=getPwd(),a=r[0],u=r[1],c=i.pathDetail(a);if(c){var s=candidates(c,n);if("string"!=typeof s){var p=s.indexOf(c.path),f=getAdjacentPath(p,s,a,u);s[p-2]||PPx.linemessage('!"'+n.msg),s[p-1]&&PPx.Execute('*jumppath "'+f+'"'),cache.isStaymode&&(cache.debounce=t)}else PPx.linemessage('!"'+s)}else PPx.linemessage('!"'+o.ROOT)},ppx_finally=function(){debugMsg("Echo","instance remain moveDirectory.stay.js")},hasDebounceTime=function(e){var t=Number(e);return!Number.isNaN(t)&&t>=1e3},getPwd=function(){var e=PPx.Extract("%FDVN");return 0===e.indexOf("#:")?[PPx.Extract("%FDN"),e]:[e]},sortItems=function(e,t,n){var r;if(cache.isStaymode&&cache.wd===e.wd&&e.type<61)r=cache.data;else if(cache.isStaymode&&cache.wd===e.wd&&e.type>=61&&cache.ext===e.ext)r=cache.data;else{var a,i=tmp().file,u='-mask:"'+n+'" -utf8 -dir:on -subdir:off -listfile:'+i+" -name";PPx.Execute('*whereis -path:"'+e.wd+'\\" '+u);var o=readLines({path:i});if(a=o[0],r=o[1],isError(a,r))return r;cache.wd=e.wd,cache.ext=e.ext,cache.data=r}return r.lines.length<=1?c.noItem:r.lines.sort((function(e,n){return e.toLowerCase()<n.toLowerCase()?t.l:t.r}))},candidates=function(e,t){switch(e.type){case 0:case 1:case 3:return sortItems(e,t,"a:d+s-");case 4:case 61:case 62:case 63:case 64:case 96:return e.path=e.path.slice(0,-1),sortItems(e,t,e.ext);default:return"DirectoryType: "+e.type+", "+c.notSupport}},getAdjacentPath=function(e,t,n,r){var a=t[Math.max(e-1,0)];if(!r)return a;var i=/[/\\][^/\\]+$/;return n=n.replace(i,""),r=r.replace(i,""),a.replace(n,r)},debugMsg=function(e,t){cache.isDebug&&PPx[e]("[DEBUG] "+t)};main();
