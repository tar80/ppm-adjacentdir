Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){var n;if(null==this)throw new Error('Array.indexOf: "this" is null or not defined');var r=Object(this),a=r.length>>>0;if(0===a)return-1;var i=null!=e?e:0;if(Math.abs(i)===Infinity&&(i=0),i>=a)return-1;for(n=Math.max(i>=0?i:a-Math.abs(i),0);n<a;){if(n in r&&r[n]===t)return n;n++}return-1});var validArgs=function(){for(var t=[],e=PPx.Arguments;!e.atEnd();e.moveNext())t.push(e.value);return t},t={ppmName:"ppx-plugin-manager",ppmVersion:.95,language:"ja",encode:"utf16le",nlcode:"\r\n",nltype:"crlf",ppmID:"P",ppmSubID:"Q"},useLanguage=function(){var e=PPx.Extract("%*getcust(S_ppm#global:lang)");return"en"===e||"ja"===e?e:t.language},tmp=function(){var t=PPx.Extract('%*extract(C,"%%*temp()")');return{dir:t,file:t+"_ppmtemp",lf:t+"_temp.xlf",stdout:t+"_stdout",stderr:t+"_stderr",ppmDir:function(){var t=PPx.Extract("%'temp'%\\ppm");return PPx.Execute("*makedir "+t),t}}},isEmptyStr=function(t){return""===t},isError=function(t,e){return t&&"string"==typeof e},e=PPx.CreateObject("Scripting.FileSystemObject"),expandNlCode=function(t){var e="\n",n=t.indexOf("\r");return~n&&(e="\r\n"===t.substring(n,n+2)?"\r\n":"\r"),e},_exec=function(t,e){try{var n;return[!1,null!=(n=e())?n:""]}catch(r){return[!0,""]}finally{t.Close()}},read=function(t){var n=t.path,r=t.enc,a=void 0===r?"utf8":r;if(!e.FileExists(n))return[!0,n+" not found"];var i=e.GetFile(n);if(0===i.Size)return[!0,n+" has no data"];var o=!1,u="";if("utf8"===a){var s=PPx.CreateObject("ADODB.Stream"),c=_exec(s,(function(){return s.Open(),s.Charset="UTF-8",s.LoadFromFile(n),s.ReadText(-1)}));o=c[0],u=c[1]}else{var p="utf16le"===a?-1:0,l=i.OpenAsTextStream(1,p),f=_exec(l,(function(){return l.ReadAll()}));o=f[0],u=f[1]}return o?[!0,"Unable to read "+n]:[!1,u]},readLines=function(t){var e,n=t.path,r=t.enc,a=void 0===r?"utf8":r,i=t.linefeed,o=read({path:n,enc:a}),u=o[0],s=o[1];if(u)return[!0,s];i=null!=(e=i)?e:expandNlCode(s.slice(0,1e3));var c=s.split(i);return isEmptyStr(c[c.length-1])&&c.pop(),[!1,{lines:c,nl:i}]},n="%sgu'ppmlib'\\discardStayMode.js",r=["KC_main","KV_main","KV_img","KV_crt","KV_page","KB_edit","K_ppe","K_edit"],_validTable=function(t){return~r.indexOf(t)?t:"KC_main"},discard=function(t){return function(e){var n=e.table,r=e.label,a=e.mapkey,i=e.cond,o=void 0===i?"instantly":i,u=e.debug,s=void 0===u?"0":u,c=PPx.StayMode,p=PPx.Extract("%n"),l=PPx.Extract("%FDV"),f="*linecust "+r+p+","+_validTable(n)+":"+t+",",d={instantly:"",once:'*if("'+p+'"=="%n")%:',hold:'*if("'+p+'"=="%n")&&("'+l+'"!="%FDV")%:'}[o],x=[f];a&&(PPx.Execute("*mapkey use,"+a),x.push("*mapkey delete,"+a)),x.push('*js ":'+c+',ppx_Discard",'+s+","+r),PPx.Execute(f+"%(*if %*stayinfo("+c+")%:"+d+x.join("%:")+"%)"),PPx.Execute('*run -nostartmsg %0pptrayw.exe -c %%K"@LOADCUST"')}},ppx_Discard=function(t,e){var n;PPx.StayMode=0,e=null!=(n=e)?n:"","DEBUG"===t&&PPx.linemessage("[DEBUG] discard "+e)},a={hold:function(t,e){var r=PPx.StayMode,a="ppm_staymode"+r;PPx.Execute("*run -noppb -hide -nostartmsg %0ppbw.exe -c *wait "+t+"%%:*script "+n+","+a+","+r+","+e)}},i=(discard("ACTIVEEVENT"),discard("LOADEVENT"),function(t,e,n,r,a){var i="*linecust "+n+","+_validTable(t),o=i+":"+e+",",u={instantly:"",once:'*if("%n"=="%%n")',hold:'*if("%n"=="%%n")&&("%FDV"=="%%FDV")'}[a];PPx.Execute(i+":"+e+","+u+"%%:"+o+"%%:"+r),PPx.Execute('%K"@LOADCUST"')}),o={sortDetail:function(t,e,n){return 0!==t&&(t=1),{0:{l:-1,r:1,msg:e},1:{l:1,r:-1,msg:n}}[t]},pathDetail:function(t){var e={path:"",wd:"",name:"",ext:"",type:0},n=/^(.*)\\((?:.*\.)?(?!$)(.*))/;return PPx.Extract(t).replace(n,(function(t,n,r,a){return e.path=t+"\\",e.wd=n,e.name=r,e.ext="."+a.toLowerCase(),e.type=PPx.DirectoryType,""})),e.wd?e:undefined}},u=80140,s={root:"<<root>>",top:"<top>",bottom:"<bottom>"},c={en:{noItem:"No adjacent directories",notSupport:"Not supported"},ja:{noItem:"隣接ディレクトリはありません",notSupport:"非対象"}}[useLanguage()],p={wd:"",ext:"",data:{}},main=function(){var t=validArgs(),e=t[0],n=t[1],r=t[2],i=hasDebounceTime(n);i&&(PPx.StayMode=u,"DEBUG"===r&&PPx.linemessage("[DEBUG] start "+u),a.hold(n,r)),ppx_resume(e,"0",i)},ppx_finally=function(){return PPx.Echo("[WARN] instance remain moveDirectory.stay.js")},ppx_resume=function(t,e,n){void 0===t&&(t="1"),void 0===e&&(e="5000"),void 0===n&&(n=!0);var r=o.sortDetail(Number(t),s.top,s.bottom),a=getPwd(),i=a[0],c=a[1],p=o.pathDetail(i);if(p){var l=candidates(p,r,n);if("string"!=typeof l){var f=l.indexOf(p.path),d=getAdjacentPath(f,l,i,c);if(l[f-2]||PPx.linemessage('!"'+r.msg),l[f-1]&&PPx.Execute('*jumppath "'+d+'"'),n){var x="ppm_sm"+u;PPx.Execute("*string u,"+x+"="+e)}}else PPx.linemessage('!"'+l)}else PPx.linemessage('!"'+s.root)},hasDebounceTime=function(t){var e=Number(t);return!Number.isNaN(e)&&e>=1e3},getPwd=function(){var t=PPx.Extract("%FDVN");return 0===t.indexOf("#:")?[PPx.Extract("%FDN"),t]:[t]},sortItems=function(t,e,n,r){var a;if(r&&p.wd===t.wd&&t.type<61)a=p.data;else if(r&&p.wd===t.wd&&t.type>=61&&p.ext===t.ext)a=p.data;else{var i,o=tmp().file,u='-mask:"'+n+'" -utf8 -dir:on -subdir:off -listfile:'+o+" -name";PPx.Execute('*whereis -path:"'+t.wd+'\\" '+u);var s=readLines({path:o});if(i=s[0],a=s[1],isError(i,a))return a;p={wd:t.wd,ext:t.ext,data:a}}return a.lines.length<=1?c.noItem:a.lines.sort((function(t,n){return t.toLowerCase()<n.toLowerCase()?e.l:e.r}))},candidates=function(t,e,n){switch(t.type){case 0:case 1:case 3:return sortItems(t,e,"a:d+s-",n);case 4:case 61:case 62:case 63:case 64:case 96:return t.path=t.path.slice(0,-1),sortItems(t,e,t.ext,n);default:return"DirectoryType: "+t.type+", "+c.notSupport}},getAdjacentPath=function(t,e,n,r){var a=e[Math.max(t-1,0)];if(!r)return a;var i=/[/\\][^/\\]+$/;return n=n.replace(i,""),r=r.replace(i,""),a.replace(n,r)};main();
